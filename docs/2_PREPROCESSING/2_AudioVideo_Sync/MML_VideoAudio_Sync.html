<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.552">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>MOBILE MULTIMODAL LAB (MML): Video Clipping and Audio-Video Alignment</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="style.css">
</head>

<body class="nav-sidebar floating nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
        <div class="quarto-navbar-tools tools-end">
    <div class="dropdown">
      <a href="" title="" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label=""><i class="bi bi-github"></i></a>
      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item quarto-navbar-tools-item" href="https://github.com/MultiMobLab/Mobile-Multimodal-Lab">
            Source Code
            </a>
          </li>
          <li>
            <a class="dropdown-item quarto-navbar-tools-item" href="https://github.com/MultiMobLab/Mobile-Multimodal-Lab/issues">
            Report a Bug
            </a>
          </li>
      </ul>
    </div>
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">MOBILE MULTIMODAL LAB (MML): Video Clipping and Audio-Video Alignment</li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Home</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Lab Setup</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
 <span class="menu-text">xxx</span>
  </li>
          <li class="sidebar-item">
 <span class="menu-text">xxx</span>
  </li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Preprocessing</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../2_PREPROCESSING/1_XDF_PROCESSING/MML_XDF_Preprocessing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Mobile Multimodal Lab (MML): XDF Preprocessing</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Motion Tracking</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../3_MOTION_TRACKING/1_Video_Segmentation/Donders MML_Video Split.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Donderrs MML: Splitting Multiple Videos</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">Analysis</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../4b_SynchronyAnalyses/processing_and_visualization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">MMLAB PLOTS MULTIMODAL PLOT BONANZA</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
 <span class="menu-text">Visualization</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../5_ANIMATIONS/Donders_MML_Multimodal_Animations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">DONDERS MML: Multimodal Animations</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">MOBILE MULTIMODAL LAB (MML): Video Clipping and Audio-Video Alignment</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="MML_VideoAudio_Sync_files/figure-html/60d4c572-e05b-4c3b-9db9-413b1195bf95-1-Donders MML LOGO.png" class="img-fluid figure-img"></p>
<figcaption>Donders MML LOGO.png</figcaption>
</figure>
</div>
<section id="code-overview" class="level3">
<h3 class="anchored" data-anchor-id="code-overview">CODE OVERVIEW</h3>
<p>This script performs video clipping and audio-video alignment for multimodal data recorded with the Mobile Multimodal Lab (MML). It uses <code>.csv</code>-based LSL timing, raw compressed video files, and denoised audio files to produce precisely clipped and synchronized outputs. The script also allows optional overlay of LSL timestamps onto video frames for visual inspection of alignment.</p>
<hr>
<p><strong>Packages</strong><br>
This section imports all necessary packages for file handling, data manipulation, audio/video processing, plotting, GUI interaction, and progress feedback. See <code>requirements.txt</code> for full details.</p>
<hr>
<p><strong>Key Variables and Paths</strong> - <code>input_video_folder</code>: location of the raw recorded video files - <code>input_file_folder</code>: folder containing the <code>.csv</code> files extracted from <code>.xdf</code> recordings - <code>output_video_folder</code>: folder where clipped video files will be saved - <code>output_audiovideo_folder</code>: folder where merged audio-video files will be saved - <code>output_overlay_folder</code>: (optional) folder for videos with LSL overlays - <code>audio_video_pattern_matching</code>: regex used to extract participant and session IDs</p>
<hr>
<p><strong>Step 1: Identify Input Files</strong> - Automatically traverses input folders to find: - LSL video <code>.csv</code> files (video frame numbers and timestamps) - denoised <code>.wav</code> audio files (typically labeled <code>Mic</code>) - raw compressed video files (e.g., <code>.avi</code> with <code>"output_compr"</code>)</p>
<hr>
<p><strong>Step 2: Clip Videos Based on LSL Frame Timestamps</strong> - Loads each <code>.csv</code> file to determine start and end frames - Matches the LSL <code>.csv</code> to the corresponding raw video based on participant ID and session - Calculates the frame rate from LSL data - Clips the video using either: - <code>moviepy</code> (default): slower but accurate frame-by-frame clipping - (optional) <code>ffmpeg</code>: faster, based on time conversion - Saves the clipped video using consistent folder structure</p>
<hr>
<p><strong>Step 3: Merge Audio and Video</strong> - Matches clipped video with corresponding denoised audio - Uses <code>ffmpeg</code> to combine them into a single synchronized file - Saves merged outputs to the defined folder - Audio is encoded as AAC and video stream is copied to avoid recompression</p>
<hr>
<p><strong>Step 4 (Optional): Overlay LSL Time on Videos</strong> - Re-scans the folder for previously synchronized audio-video files - Loads associated <code>.csv</code> files containing LSL frame timestamps - Uses OpenCV to overlay <code>LSL Time</code> and <code>Frame</code> number on each frame of the video - Saves the annotated output to a designated overlay folder</p>
<hr>
<p><strong>Output Structure</strong> - Clipped videos: <code>video_clipped/{participant}/{day}/{filename}.avi</code> - Merged audio-video: <code>audiovideo_merged/{participant}/{day}/{filename}.avi</code> - Optional overlay: <code>audiovideo_overlay/{participant}/{day}/{filename}.avi</code></p>
<hr>
<p>Author: Davide Ahmar</p>
<p>Last Modified: 13/05/2025 by Davide Ahmar</p>
</section>
<section id="importing-relevant-packages" class="level2">
<h2 class="anchored" data-anchor-id="importing-relevant-packages">0. Importing Relevant Packages</h2>
<div id="96a33655-b420-425b-8ece-4cac1de64c34" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os             <span class="co"># Importing the os module which provides functions for interacting with the operating system</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyxdf          <span class="co"># Importing pyxdf, a Python library for reading XDF files</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob           <span class="co"># Importing the glob module which helps in finding files/directories with specific patterns</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd   <span class="co"># Importing pandas library (abbreviated as pd), which is used for data manipulation and analysis</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np    <span class="co"># Importing numpy library (abbreviated as np), which is used for numerical computations</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> wave           <span class="co"># Importing wave module for reading and writing WAV files (usually audio files) </span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> struct         <span class="co"># Importing struct module which provides functions to convert between Python values and C structs</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math           <span class="co"># Importing math module which provides mathematical functions</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random         <span class="co"># Importing random module for generating random numbers</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.io <span class="im">import</span> wavfile  <span class="co"># Importing wavfile module from scipy.io (a library built on numpy), for reading and writing WAV files</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> noisereduce <span class="im">as</span> nr      <span class="co"># Importing noisereduce module for noise reduction in audio signals</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json            <span class="co"># Importing json module for working with JSON data</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cv2            <span class="co"># Importing OpenCV library for computer vision tasks</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> moviepy.editor <span class="im">import</span> (                <span class="co"># Importing various classes and functions from moviepy.editor module</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>                            VideoFileClip,  <span class="co"># Class for working with video files</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>                            AudioFileClip,  <span class="co"># Class for working with audio files</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>                            CompositeAudioClip)  <span class="co"># Class for composing audio clip</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> moviepy.video.io.VideoFileClip <span class="im">import</span> VideoFileClip</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> moviepy.video.io.ffmpeg_tools <span class="im">import</span> ffmpeg_extract_subclip  <span class="co"># video  clipping fucntion </span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> moviepy.video.io.VideoFileClip <span class="im">import</span> VideoFileClip          <span class="co"># alternative video clipping function</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt                                   <span class="co"># Importing pyplot library to create figures and plot data </span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.widgets <span class="im">import</span> Slider  </span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tkinter                                                    <span class="co"># GUI toolkit to open and save files</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tkinter <span class="im">import</span> filedialog                                    <span class="co"># GUI toolkit to open and save files</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> subprocess </span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm.notebook <span class="im">import</span> tqdm</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re                                                         <span class="co"># Importing re module for working with regular expressions</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Everything was imported succesfully"</span>) <span class="co">#as terminal</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Everything was imported succesfully</code></pre>
</div>
</div>
</section>
<section id="establish-relevant-paths-variabls-functions" class="level2">
<h2 class="anchored" data-anchor-id="establish-relevant-paths-variabls-functions">1. Establish Relevant Paths, Variabls &amp; Functions</h2>
<div id="489fb651-acc9-43ab-bfd8-f015695f2343" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------ PATHS -----------------------------------------------------</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>input_video_folder <span class="op">=</span> <span class="vs">r'\\fileserver.dccn.nl\project\3025011.01\pilots\pilot_data_davide'</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co">#input_file_folder   = '../1_XDF_PROCESSING/data_processed/lateststart_earliestend'    # this folder contains the csv files extracted from the XDF files (data_processed)</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co">#input_file_folder =   '../1_XDF_PROCESSING/data_processed_temp/manual_startend'</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>input_file_folder   <span class="op">=</span> <span class="st">'../1_XDF_PROCESSING/data_processed_final/marker_3pairs'</span>    <span class="co"># this folder contains the csv files extracted from the XDF files (data_processed)</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>output_video_folder <span class="op">=</span> <span class="st">'./video_clipped/marker_3pairs/'</span>     <span class="co"># this folder will contain the clipped videos</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>output_audiovideo_folder <span class="op">=</span> <span class="st">'./audiovideo_merged/marker_3pairs'</span>     <span class="co"># this folder will contain the audio files extracted from the videos</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co">#output_overlay_folder = './audiovideo_overlay/lateststart_earliestend' </span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Input video folder ="</span>, os.path.abspath(input_video_folder))</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Input file folder ="</span>, os.path.abspath(input_file_folder))</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Output_video folder ="</span>, os.path.abspath(output_video_folder))</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Output_audiovideo folder ="</span>, os.path.abspath(output_audiovideo_folder))</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------ VARIABLES -----------------------------------------------------</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Dictionary to map file extensions to codecs</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>extension_to_codec <span class="op">=</span> {</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">'.mp4'</span>: <span class="st">'libx264'</span>,</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">'.avi'</span>: <span class="st">'XVID'</span>,</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">'.mov'</span>: <span class="st">'libx264'</span>,</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">'.mkv'</span>: <span class="st">'libx264'</span>,</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">'.flv'</span>: <span class="st">'flv'</span>,</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add more mappings as needed</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>                    }</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a><span class="co"># AUDIO-VIDEO MATCHING: Regular expression pattern to match the participant's video file name. Change as needed. </span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>audio_video_pattern_matching <span class="op">=</span> re.<span class="bu">compile</span>(<span class="vs">r'pilot_(\d+)_d(\d+)'</span>)</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a><span class="co"># pilot_01_d2_speech_lsl_Mic_latest_start_earliest_end_denoised.wav</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a><span class="co"># pilot_05_d2_speech_output_comp</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a><span class="co"># pilot_01_d2_speech_lsl_Video_latest_start_earliest_end_denoised.wav</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a><span class="co">"""In our case the files are named as # pilot_xx_dx_speech_lsl_Mic_latest_start_earliest_end_denoised.wav and # pilot_xx_dx_speech_output_comp</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a><span class="co">        where x are changing expression inside this regular pattern. </span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a><span class="co">            pilot_: Matches the static string "pilot_".</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a><span class="co">            (\d+): Captures one or more digits (xx in your case).</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a><span class="co">            _d(\d+): Captures the dynamic d part followed by digits (dx).</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a><span class="co">            _speech: Matches the static string _speech.</span></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a><span class="co">    The regular expression is used to match the file names between audios and videos audiio audio-video alignment"""</span></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Dictionary to map file extensions to FourCC codecs</span></span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>extension_to_codec <span class="op">=</span> {</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>    <span class="st">'.mp4'</span>: <span class="st">'H264'</span>,  <span class="co"># 'H264' is a valid FourCC code for H.264</span></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>    <span class="st">'.avi'</span>: <span class="st">'XVID'</span>,  <span class="co"># 'XVID' is a common FourCC for AVI</span></span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>    <span class="st">'.mov'</span>: <span class="st">'H264'</span>,  <span class="co"># Again, use 'H264' or 'MP4V'</span></span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>    <span class="st">'.mkv'</span>: <span class="st">'H264'</span>,  <span class="co"># Use 'H264' for MKV files too</span></span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>    <span class="st">'.flv'</span>: <span class="st">'FLV1'</span>,  <span class="co"># 'FLV1' is a valid codec for FLV</span></span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add more mappings as needed</span></span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------ FUNCTIONS -----------------------------------------------------</span></span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a><span class="co"># VIDEO: Creating a function named frame_to_time to convert frame number to time format </span></span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> frame_to_time(frame, fps):</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a><span class="co">    frame_to_time converts a given frame number to a time format (HH:MM:SS.SS) based on the frames per second (fps).</span></span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a><span class="co">    Arguments:</span></span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a><span class="co">        frame (int): The frame number to be converted.</span></span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a><span class="co">        fps (float): The frames per second of the video.</span></span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a><span class="co">        str: The time format as a string in the format "HH:MM:SS.SS".</span></span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>    seconds <span class="op">=</span> frame <span class="op">/</span> fps</span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>    hours <span class="op">=</span> <span class="bu">int</span>(seconds <span class="op">//</span> <span class="dv">3600</span>)</span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>    minutes <span class="op">=</span> <span class="bu">int</span>((seconds <span class="op">%</span> <span class="dv">3600</span>) <span class="op">//</span> <span class="dv">60</span>)</span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>    seconds <span class="op">=</span> seconds <span class="op">%</span> <span class="dv">60</span></span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="ss">f"</span><span class="sc">{</span>hours<span class="sc">:02}</span><span class="ss">:</span><span class="sc">{</span>minutes<span class="sc">:02}</span><span class="ss">:</span><span class="sc">{</span>seconds<span class="sc">:.2f}</span><span class="ss">"</span></span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Function </span><span class="ch">\"</span><span class="st">frame_to_time</span><span class="ch">\"</span><span class="st"> created sucesfully"</span>) </span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to extract specified events (with correspodning LSL times) from XDF stream (useful for plotting)</span></span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_events(stream, event_names):</span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a><span class="co">    Extracts events and corresponding LSL times from the given stream that match any of the event_names.</span></span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a><span class="co">    stream (dict): The stream containing time stamps and event data.</span></span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a><span class="co">    event_names (list of str): List of event name substrings to look for in the events.</span></span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a><span class="co">    np.array: An array where each row contains a timestamp and the full event name.</span></span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a>    events <span class="op">=</span> []  <span class="co"># Initialize an empty list to store matching events</span></span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if the stream type is "Markers"</span></span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> stream[<span class="st">'info'</span>][<span class="st">'type'</span>][<span class="dv">0</span>] <span class="op">!=</span> <span class="st">"Markers"</span>:</span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"ERROR: The stream provided (</span><span class="sc">{</span>stream[<span class="st">'info'</span>][<span class="st">'name'</span>][<span class="dv">0</span>]<span class="sc">}</span><span class="ss">) is not a Marker stream"</span>)</span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Iterate over the time stamps and corresponding events in the stream</span></span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> timestamp, event <span class="kw">in</span> <span class="bu">zip</span>(stream[<span class="st">'time_stamps'</span>], stream[<span class="st">'time_series'</span>]):</span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check if any of the specified event names are in the current event</span></span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> name <span class="kw">in</span> event_names:</span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> name <span class="kw">in</span> event[<span class="dv">0</span>]:</span>
<span id="cb3-99"><a href="#cb3-99" aria-hidden="true" tabindex="-1"></a>                <span class="co"># If a match is found, append the timestamp and full event name to the list</span></span>
<span id="cb3-100"><a href="#cb3-100" aria-hidden="true" tabindex="-1"></a>                events.append([timestamp, event[<span class="dv">0</span>]])</span>
<span id="cb3-101"><a href="#cb3-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-102"><a href="#cb3-102" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert the list of events to a NumPy array and return it</span></span>
<span id="cb3-103"><a href="#cb3-103" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.array(events)</span>
<span id="cb3-104"><a href="#cb3-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-105"><a href="#cb3-105" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Function </span><span class="ch">\"</span><span class="st">get_events</span><span class="ch">\"</span><span class="st"> created sucesfully"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Input video folder = \\fileserver.dccn.nl\project\3025011.01\pilots\pilot_data_davide
Input file folder = f:\SpeakUp-2.0\2_PREPROCESSING\1_XDF_PROCESSING\data_processed_final\marker_3pairs
Output_video folder = f:\SpeakUp-2.0\2_PREPROCESSING\2_Audio_Video_Sync\video_clipped\marker_3pairs
Output_audiovideo folder = f:\SpeakUp-2.0\2_PREPROCESSING\2_Audio_Video_Sync\audiovideo_merged\marker_3pairs
Function "frame_to_time" created sucesfully
Function "get_events" created sucesfully</code></pre>
</div>
</div>
<section id="identify-relevant-cvs-files-audio-files-and-videos-by-navigating-through-input-folders" class="level3">
<h3 class="anchored" data-anchor-id="identify-relevant-cvs-files-audio-files-and-videos-by-navigating-through-input-folders">2. Identify Relevant CVS files, Audio Files and Videos by navigating through Input Folders</h3>
<div id="760b1fb0" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">## 1. FIND LSL VIDEO FILES (csv files) IN THE INPUT FOLDER</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>LSL_video_list <span class="op">=</span> []  <span class="co"># Initialize an empty list to store paths of video files (csv LSL data)</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> os.path.exists(input_file_folder):  <span class="co"># Check if the input folder exists</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Traverse through the directory and its subdirectories to find XDF files</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> root, dirs, files <span class="kw">in</span> os.walk(os.path.abspath(input_file_folder)):  <span class="co"># Walk through the directory tree</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> files:</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="st">"speech"</span> <span class="kw">in</span> <span class="bu">file</span> <span class="kw">and</span> <span class="st">'Video'</span> <span class="kw">in</span> <span class="bu">file</span> <span class="kw">and</span> <span class="bu">file</span>.endswith(<span class="st">".csv"</span>):  <span class="co"># Check that the words "speech" and "Video" are in the file name and that it is a CSV file</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>                    LSL_video_list.append(os.path.join(root, <span class="bu">file</span>))  <span class="co"># Append the full path to the xdf_files list</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> LSL_video_list:  <span class="co"># Check if any files were found</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f'We have identified the following LSL video files: </span><span class="sc">{</span>LSL_video_list<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:  <span class="co"># If no XDF files were found</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">'No LSL video files found.'</span>)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>: <span class="co"># If the input folder does not exist or is not accessible</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'The folder </span><span class="sc">{</span>input_file_folder<span class="sc">}</span><span class="ss"> does not exist or is not accessible.'</span>)</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"An error occurred: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a><span class="co">## 2. FIND AUDIO FILES (.wav files) IN THE INPUT FILE FOLDER</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>audio_list <span class="op">=</span> []  <span class="co"># Initialize an empty list to store paths of video files (csv LSL data)</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> os.path.exists(input_video_folder):  <span class="co"># Check if the input folder exists</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Traverse through the directory and its subdirectories to find XDF files</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> root, dirs, files <span class="kw">in</span> os.walk(os.path.abspath(input_file_folder)):  <span class="co"># Walk through the directory tree</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> files:</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="st">"speech"</span> <span class="kw">in</span> <span class="bu">file</span> <span class="kw">and</span> <span class="st">'Mic'</span> <span class="kw">in</span> <span class="bu">file</span> <span class="kw">and</span> <span class="st">'denoised'</span> <span class="kw">in</span> <span class="bu">file</span> <span class="kw">and</span> <span class="bu">file</span>.endswith(<span class="st">".wav"</span>):  <span class="co"># Check that the words "speech" and "Mic" and "denoised" are in the file name and that it is a wav file</span></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>                    audio_list.append(os.path.join(root, <span class="bu">file</span>))  <span class="co"># Append the full path to the xdf_files list</span></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> audio_list:  <span class="co"># Check if any files were found</span></span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f'We have identified the following Audio files: </span><span class="sc">{</span>audio_list<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:  <span class="co"># If no  files were found</span></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">'No audio files found.'</span>)</span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>: <span class="co"># If the input folder does not exist or is not accessible</span></span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'The folder </span><span class="sc">{</span>input_file_folder<span class="sc">}</span><span class="ss"> does not exist or is not accessible.'</span>)</span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"An error occurred: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a><span class="co">## 2. FIND RAW VIDEO FILES IN THE INPUT VIDEO FOLDER</span></span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>raw_video_list <span class="op">=</span> []  <span class="co"># Initialize an empty list to store paths of video files (csv LSL data)</span></span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> os.path.exists(input_video_folder):  <span class="co"># Check if the input folder exists</span></span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Traverse through the directory and its subdirectories to find XDF files</span></span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> root, dirs, files <span class="kw">in</span> os.walk(os.path.abspath(input_video_folder)):  <span class="co"># Walk through the directory tree</span></span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> files:</span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="st">"speech"</span> <span class="kw">in</span> <span class="bu">file</span> <span class="kw">and</span> <span class="st">'output_compr'</span> <span class="kw">in</span> <span class="bu">file</span> <span class="kw">and</span> <span class="bu">file</span>.endswith(<span class="st">".avi"</span>):  <span class="co"># Check that the words "speech" and "output_compr" are in the file name and that it is a avi file</span></span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a>                    raw_video_list.append(os.path.join(root, <span class="bu">file</span>))  <span class="co"># Append the full path to the xdf_files list</span></span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> raw_video_list:  <span class="co"># Check if any files were found</span></span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f'We have identified the following Video files: </span><span class="sc">{</span>raw_video_list<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:  <span class="co"># If no files were found</span></span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">'No video files found.'</span>)</span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>: <span class="co"># If the input folder does not exist or is not accessible</span></span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'The folder </span><span class="sc">{</span>input_video_folder<span class="sc">}</span><span class="ss"> does not exist or is not accessible.'</span>)</span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"An error occurred: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>We have identified the following LSL video files: ['f:\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed_final\\marker_3pairs\\pilot_01\\day2\\pilot_01_d2_speech_lsl_Video_Speech_Start_SUD_1_Start.csv', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed_final\\marker_3pairs\\pilot_01\\day2\\pilot_01_d2_speech_lsl_Video_SUD_1_End_SUD_2_Start.csv', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed_final\\marker_3pairs\\pilot_01\\day2\\pilot_01_d2_speech_lsl_Video_SUD_2_End_SUD_3_Start.csv', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed_final\\marker_3pairs\\pilot_01\\day3\\pilot_01_d3_speech_lsl_Video_Speech_Start_SUD_1_Start.csv', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed_final\\marker_3pairs\\pilot_01\\day3\\pilot_01_d3_speech_lsl_Video_SUD_1_End_SUD_2_Start.csv', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed_final\\marker_3pairs\\pilot_01\\day3\\pilot_01_d3_speech_lsl_Video_SUD_2_End_SUD_3_Start.csv', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed_final\\marker_3pairs\\pilot_02\\day2\\pilot_02_d2_speech_lsl_Video_Speech_Start_SUD_1_Start.csv', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed_final\\marker_3pairs\\pilot_02\\day2\\pilot_02_d2_speech_lsl_Video_SUD_1_End_SUD_2_Start.csv', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed_final\\marker_3pairs\\pilot_02\\day2\\pilot_02_d2_speech_lsl_Video_SUD_2_End_SUD_3_Start.csv', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed_final\\marker_3pairs\\pilot_02\\day3\\pilot_02_d3_speech_lsl_Video_Speech_Start_SUD_1_Start.csv', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed_final\\marker_3pairs\\pilot_02\\day3\\pilot_02_d3_speech_lsl_Video_SUD_1_End_SUD_2_Start.csv', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed_final\\marker_3pairs\\pilot_02\\day3\\pilot_02_d3_speech_lsl_Video_SUD_2_End_SUD_3_Start.csv', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed_final\\marker_3pairs\\pilot_04\\day2\\pilot_04_d2_speech_lsl_Video_Speech_Start_SUD_1_Start.csv', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed_final\\marker_3pairs\\pilot_04\\day2\\pilot_04_d2_speech_lsl_Video_SUD_1_End_SUD_2_Start.csv', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed_final\\marker_3pairs\\pilot_04\\day2\\pilot_04_d2_speech_lsl_Video_SUD_2_End_SUD_3_Start.csv', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed_final\\marker_3pairs\\pilot_05\\day2\\pilot_05_d2_speech_lsl_Video_Speech_Start_SUD_1_Start.csv', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed_final\\marker_3pairs\\pilot_05\\day2\\pilot_05_d2_speech_lsl_Video_SUD_1_End_SUD_2_Start.csv', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed_final\\marker_3pairs\\pilot_05\\day2\\pilot_05_d2_speech_lsl_Video_SUD_2_End_SUD_3_Start.csv', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed_final\\marker_3pairs\\pilot_06\\day2\\pilot_06_d2_speech_lsl_Video_Speech_Start_SUD_1_Start.csv', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed_final\\marker_3pairs\\pilot_06\\day2\\pilot_06_d2_speech_lsl_Video_SUD_1_End_SUD_2_Start.csv', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed_final\\marker_3pairs\\pilot_06\\day2\\pilot_06_d2_speech_lsl_Video_SUD_2_End_SUD_3_Start.csv']
We have identified the following Audio files: ['f:\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed_final\\marker_3pairs\\pilot_01\\day2\\pilot_01_d2_speech_lsl_Mic_Speech_Start_SUD_1_Start_denoised.wav', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed_final\\marker_3pairs\\pilot_01\\day2\\pilot_01_d2_speech_lsl_Mic_SUD_1_End_SUD_2_Start_denoised.wav', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed_final\\marker_3pairs\\pilot_01\\day2\\pilot_01_d2_speech_lsl_Mic_SUD_2_End_SUD_3_Start_denoised.wav', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed_final\\marker_3pairs\\pilot_01\\day3\\pilot_01_d3_speech_lsl_Mic_Speech_Start_SUD_1_Start_denoised.wav', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed_final\\marker_3pairs\\pilot_01\\day3\\pilot_01_d3_speech_lsl_Mic_SUD_1_End_SUD_2_Start_denoised.wav', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed_final\\marker_3pairs\\pilot_01\\day3\\pilot_01_d3_speech_lsl_Mic_SUD_2_End_SUD_3_Start_denoised.wav', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed_final\\marker_3pairs\\pilot_02\\day2\\pilot_02_d2_speech_lsl_Mic_Speech_Start_SUD_1_Start_denoised.wav', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed_final\\marker_3pairs\\pilot_02\\day2\\pilot_02_d2_speech_lsl_Mic_SUD_1_End_SUD_2_Start_denoised.wav', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed_final\\marker_3pairs\\pilot_02\\day2\\pilot_02_d2_speech_lsl_Mic_SUD_2_End_SUD_3_Start_denoised.wav', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed_final\\marker_3pairs\\pilot_02\\day3\\pilot_02_d3_speech_lsl_Mic_Speech_Start_SUD_1_Start_denoised.wav', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed_final\\marker_3pairs\\pilot_02\\day3\\pilot_02_d3_speech_lsl_Mic_SUD_1_End_SUD_2_Start_denoised.wav', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed_final\\marker_3pairs\\pilot_02\\day3\\pilot_02_d3_speech_lsl_Mic_SUD_2_End_SUD_3_Start_denoised.wav', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed_final\\marker_3pairs\\pilot_04\\day2\\pilot_04_d2_speech_lsl_Mic_Speech_Start_SUD_1_Start_denoised.wav', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed_final\\marker_3pairs\\pilot_04\\day2\\pilot_04_d2_speech_lsl_Mic_SUD_1_End_SUD_2_Start_denoised.wav', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed_final\\marker_3pairs\\pilot_04\\day2\\pilot_04_d2_speech_lsl_Mic_SUD_2_End_SUD_3_Start_denoised.wav', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed_final\\marker_3pairs\\pilot_05\\day2\\pilot_05_d2_speech_lsl_Mic_Speech_Start_SUD_1_Start_denoised.wav', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed_final\\marker_3pairs\\pilot_05\\day2\\pilot_05_d2_speech_lsl_Mic_SUD_1_End_SUD_2_Start_denoised.wav', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed_final\\marker_3pairs\\pilot_05\\day2\\pilot_05_d2_speech_lsl_Mic_SUD_2_End_SUD_3_Start_denoised.wav', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed_final\\marker_3pairs\\pilot_06\\day2\\pilot_06_d2_speech_lsl_Mic_Speech_Start_SUD_1_Start_denoised.wav', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed_final\\marker_3pairs\\pilot_06\\day2\\pilot_06_d2_speech_lsl_Mic_SUD_1_End_SUD_2_Start_denoised.wav', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed_final\\marker_3pairs\\pilot_06\\day2\\pilot_06_d2_speech_lsl_Mic_SUD_2_End_SUD_3_Start_denoised.wav']
We have identified the following Video files: ['\\\\fileserver.dccn.nl\\project\\3025011.01\\pilots\\pilot_data_davide\\pilot_01\\day2\\pilot_01_d2_speech_output_compr.avi', '\\\\fileserver.dccn.nl\\project\\3025011.01\\pilots\\pilot_data_davide\\pilot_01\\day3\\pilot_01_d3_speech_output_compr.avi', '\\\\fileserver.dccn.nl\\project\\3025011.01\\pilots\\pilot_data_davide\\pilot_02\\day2\\pilot_02_d2_speech_output_compr.avi', '\\\\fileserver.dccn.nl\\project\\3025011.01\\pilots\\pilot_data_davide\\pilot_02\\day3\\pilot_02_d3_speech_output_compr.avi', '\\\\fileserver.dccn.nl\\project\\3025011.01\\pilots\\pilot_data_davide\\pilot_03\\day2\\pilot_03_d2_speech_output_compr.avi', '\\\\fileserver.dccn.nl\\project\\3025011.01\\pilots\\pilot_data_davide\\pilot_04\\day2\\pilot_04_d2_speech_output_compr.avi', '\\\\fileserver.dccn.nl\\project\\3025011.01\\pilots\\pilot_data_davide\\pilot_05\\day2\\pilot_05_d2_speech_output_compr.avi', '\\\\fileserver.dccn.nl\\project\\3025011.01\\pilots\\pilot_data_davide\\pilot_06\\day2\\pilot_06_d2_speech_output_compr.avi']</code></pre>
</div>
</div>
</section>
</section>
<section id="clipping-videos-based-on-.csv-frames-and-lsl-times" class="level2">
<h2 class="anchored" data-anchor-id="clipping-videos-based-on-.csv-frames-and-lsl-times">3. Clipping Videos Based on .CSV frames and LSL times</h2>
<div id="92e2e959" class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">##1. LOAD LSL VIDEO FILES  </span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through the files </span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> LSL_video_list: </span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'Processing </span><span class="sc">{</span><span class="bu">file</span><span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    file_path <span class="op">=</span> os.path.join(os.path.abspath(input_file_folder), <span class="bu">file</span>)  <span class="co"># Create the file path for the CSV file</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    file_data <span class="op">=</span> pd.read_csv(file_path)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Find the start and end frame numbers in the CSV file </span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    start_frame <span class="op">=</span> file_data.iloc[<span class="dv">0</span>, <span class="dv">1</span>]    <span class="co"># Get the first frame (first row, index 0) in the second coluimn (index 1)</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    end_frame   <span class="op">=</span> file_data.iloc[<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>]   <span class="co"># Get the last frame (last row, index -1) in the second coluimn (index 1)</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    fnam <span class="op">=</span> os.path.basename(<span class="bu">file</span>)[:<span class="op">-</span><span class="dv">4</span>]     <span class="co"># Extract the file name from the path and assings it to fnam, whilst removing the '.csv' extension (i.e., the last 4 characters in the string)</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    participant_num <span class="op">=</span> <span class="st">'_'</span>.join(fnam.split(<span class="st">'_'</span>)[<span class="dv">0</span>:<span class="dv">2</span>])  <span class="co"># Extract the participant number from the file name by splitting the string at the underscores and selecting the first two elements</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    day_num <span class="op">=</span> fnam.split(<span class="st">'_'</span>)[<span class="dv">2</span>]  <span class="co"># Extract the day number from the file name by splitting the string at the underscores and selecting the third element</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    condition <span class="op">=</span> <span class="st">'_'</span>.join(fnam.split(<span class="st">'_'</span>)[<span class="dv">6</span>:])  <span class="co"># Extract the condition from the file name by splitting the string at the underscores and selecting the elements from the 7th to the last element</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>    video_extension <span class="op">=</span> <span class="st">'.avi'</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create the output subfolder for the clipped videos</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    subfolder_path <span class="op">=</span> os.path.join(os.path.abspath(output_video_folder), participant_num, day_num, <span class="ss">f'</span><span class="sc">{</span>participant_num<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>day_num<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>condition<span class="sc">}{</span>video_extension<span class="sc">}</span><span class="ss">'</span>)  <span class="co"># Create the output subfolder for the clipped video with the correct extension</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'Subfolder path: </span><span class="sc">{</span>subfolder_path<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Make sure the output folder exists, if not create it</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(os.path.dirname(subfolder_path)):</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>        os.makedirs(os.path.dirname(subfolder_path), exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract the identifier from the audio file name that will be used to match the video file</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>    LSL_video_match <span class="op">=</span> audio_video_pattern_matching.search(fnam)</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> LSL_video_match :</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(f'No matching for video: {fnam}')</span></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span>  <span class="co"># Skip current iteration if the pattern is not found</span></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>    LSL_video_identifier <span class="op">=</span> LSL_video_match.group(<span class="dv">0</span>)  <span class="co"># Extract the matched portion of the string from the regex result.</span></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">#print(f'Video identifier: {LSL_video_identifier}')  # Print the matched identifier for audio</span></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Find the frame rate of the LSL frames (i.e., the number of frames per second)</span></span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>    LSL_frame_rate <span class="op">=</span> (end_frame <span class="op">-</span> start_frame) <span class="op">/</span> (file_data.iloc[<span class="op">-</span><span class="dv">1</span>, <span class="dv">0</span>] <span class="op">-</span> file_data.iloc[<span class="dv">0</span>, <span class="dv">0</span>])  <span class="co"># Calculate the frame rate by dividing the number of frames by the time difference between the first and last frame</span></span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. LOAD CORRESPDONDING RAW VIDELoad</span></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> video <span class="kw">in</span> raw_video_list :  <span class="co"># Loop through the raw video files to find the corresponding video file</span></span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'Now Loading the Video :  </span><span class="sc">{</span>os<span class="sc">.</span>path<span class="sc">.</span>basename(video)<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>        fnam <span class="op">=</span> os.path.basename(video)[:<span class="op">-</span><span class="dv">4</span>]     <span class="co"># Extract the file name from the path and assings it to fnam, whilst removing the '.csv' extension (i.e., the last 4 characters in the string)</span></span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract the identifier from the audio file name that will be used to match the video file</span></span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>        raw_video_match <span class="op">=</span> audio_video_pattern_matching.search(fnam)</span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> raw_video_match :</span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a>            <span class="co"># print(f'No matching for video: {fnam}')</span></span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span>  <span class="co"># Skip current iteration if the pattern is not found</span></span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a>        raw_video_identifier <span class="op">=</span> raw_video_match.group(<span class="dv">0</span>)  <span class="co"># Extract the matched portion of the string from the regex result.</span></span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>        <span class="co">#print(f'Video identifier: {LSL_video_identifier}')  # Print the matched identifier for audio</span></span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check that the LSL and raw video identifiers match</span></span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> LSL_video_identifier <span class="op">==</span> raw_video_identifier: </span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f'Found matching raw video: </span><span class="sc">{</span>os<span class="sc">.</span>path<span class="sc">.</span>basename(video)<span class="sc">}</span><span class="ss"> for LSL video: </span><span class="sc">{</span>os<span class="sc">.</span>path<span class="sc">.</span>basename(<span class="bu">file</span>)<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a>            video_path <span class="op">=</span> os.path.join(os.path.abspath(input_video_folder), video)</span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a>             </span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a>            capture <span class="op">=</span> cv2.VideoCapture(video_path) <span class="co"># Load the video using OpenCV</span></span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Extract the relevant metadata from the video</span></span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a>            video_frame_width  <span class="op">=</span> <span class="bu">int</span>(capture.get(cv2.CAP_PROP_FRAME_WIDTH))  </span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a>            video_frame_height <span class="op">=</span> <span class="bu">int</span>(capture.get(cv2.CAP_PROP_FRAME_HEIGHT))  </span>
<span id="cb7-76"><a href="#cb7-76" aria-hidden="true" tabindex="-1"></a>            video_frame_rate   <span class="op">=</span> capture.get(cv2.CAP_PROP_FPS)</span>
<span id="cb7-77"><a href="#cb7-77" aria-hidden="true" tabindex="-1"></a>            video_tot_frames   <span class="op">=</span> <span class="bu">int</span>(capture.get(cv2.CAP_PROP_FRAME_COUNT)) </span>
<span id="cb7-78"><a href="#cb7-78" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb7-79"><a href="#cb7-79" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Check video extension format and select the appropriate codec in the dictionary</span></span>
<span id="cb7-80"><a href="#cb7-80" aria-hidden="true" tabindex="-1"></a>            video_extension <span class="op">=</span> os.path.splitext(video_path)[<span class="dv">1</span>].lower()  <span class="co"># Extract the file extension from the video file path, ensuring it's in lowercase (e.g., '.mp4'), to enable case-insensitive matching in the dictionary</span></span>
<span id="cb7-81"><a href="#cb7-81" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> video_extension <span class="kw">in</span> extension_to_codec:</span>
<span id="cb7-82"><a href="#cb7-82" aria-hidden="true" tabindex="-1"></a>                codec <span class="op">=</span> extension_to_codec[video_extension]</span>
<span id="cb7-83"><a href="#cb7-83" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb7-84"><a href="#cb7-84" aria-hidden="true" tabindex="-1"></a>                <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"ERROR: The video extension </span><span class="sc">{</span>video_extension<span class="sc">}</span><span class="ss"> is not supported"</span>)</span>
<span id="cb7-85"><a href="#cb7-85" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb7-86"><a href="#cb7-86" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb7-87"><a href="#cb7-87" aria-hidden="true" tabindex="-1"></a>           <span class="co"># -------------------------------------------------------------------------------------------- </span></span>
<span id="cb7-88"><a href="#cb7-88" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb7-89"><a href="#cb7-89" aria-hidden="true" tabindex="-1"></a>            <span class="co"># ## 3. CLIP THE VIDEO USING FFMPEG (FASTER, BASED ON TIMES (converted from frame numbers))</span></span>
<span id="cb7-90"><a href="#cb7-90" aria-hidden="true" tabindex="-1"></a>           </span>
<span id="cb7-91"><a href="#cb7-91" aria-hidden="true" tabindex="-1"></a>            <span class="co"># # Converting the LSL frames to the video time format to find start_cut and end_cut for the video</span></span>
<span id="cb7-92"><a href="#cb7-92" aria-hidden="true" tabindex="-1"></a>            <span class="co"># start_cut_time = frame_to_time(start_frame, LSL_frame_rate)</span></span>
<span id="cb7-93"><a href="#cb7-93" aria-hidden="true" tabindex="-1"></a>            <span class="co"># end_cut_time = frame_to_time(end_frame, LSL_frame_rate)</span></span>
<span id="cb7-94"><a href="#cb7-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-95"><a href="#cb7-95" aria-hidden="true" tabindex="-1"></a>            <span class="co"># print("start_cut_time" + str(start_cut_time))</span></span>
<span id="cb7-96"><a href="#cb7-96" aria-hidden="true" tabindex="-1"></a>            <span class="co"># print("end_cut_time" + str(end_cut_time))</span></span>
<span id="cb7-97"><a href="#cb7-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-98"><a href="#cb7-98" aria-hidden="true" tabindex="-1"></a>            <span class="co"># print('Now cutting the video...')</span></span>
<span id="cb7-99"><a href="#cb7-99" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb7-100"><a href="#cb7-100" aria-hidden="true" tabindex="-1"></a>            <span class="co"># # Construct output file path with the same extension</span></span>
<span id="cb7-101"><a href="#cb7-101" aria-hidden="true" tabindex="-1"></a>            <span class="co"># subfolder_path = os.path.join(os.path.abspath(output_video_folder), participant_num, day_num, f'{participant_num}_{day_num}_speech_video_clipped{video_extension}')  # Create the output subfolder for the clipped video with the correct extension</span></span>
<span id="cb7-102"><a href="#cb7-102" aria-hidden="true" tabindex="-1"></a>            <span class="co"># # Make sure the output folder exists, if not create it</span></span>
<span id="cb7-103"><a href="#cb7-103" aria-hidden="true" tabindex="-1"></a>            <span class="co"># if not os.path.exists(os.path.dirname(subfolder_path)):</span></span>
<span id="cb7-104"><a href="#cb7-104" aria-hidden="true" tabindex="-1"></a>            <span class="co">#     os.makedirs(os.path.dirname(subfolder_path), exist_ok=True)</span></span>
<span id="cb7-105"><a href="#cb7-105" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb7-106"><a href="#cb7-106" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb7-107"><a href="#cb7-107" aria-hidden="true" tabindex="-1"></a>            <span class="co"># # Use ffmpeg to cut the video</span></span>
<span id="cb7-108"><a href="#cb7-108" aria-hidden="true" tabindex="-1"></a>            <span class="co"># ffmpeg_command = [</span></span>
<span id="cb7-109"><a href="#cb7-109" aria-hidden="true" tabindex="-1"></a>            <span class="co">#     'ffmpeg',</span></span>
<span id="cb7-110"><a href="#cb7-110" aria-hidden="true" tabindex="-1"></a>            <span class="co">#     '-y',                  # Add -y flag to overwrite any existing files with the same name</span></span>
<span id="cb7-111"><a href="#cb7-111" aria-hidden="true" tabindex="-1"></a>            <span class="co">#     '-i', video_path,</span></span>
<span id="cb7-112"><a href="#cb7-112" aria-hidden="true" tabindex="-1"></a>            <span class="co">#     '-ss', start_cut_time,  # start time</span></span>
<span id="cb7-113"><a href="#cb7-113" aria-hidden="true" tabindex="-1"></a>            <span class="co">#     '-to', end_cut_time,    # end time</span></span>
<span id="cb7-114"><a href="#cb7-114" aria-hidden="true" tabindex="-1"></a>            <span class="co">#     '-c', 'copy',           # copy codec (no re-encoding)</span></span>
<span id="cb7-115"><a href="#cb7-115" aria-hidden="true" tabindex="-1"></a>            <span class="co">#     subfolder_path]</span></span>
<span id="cb7-116"><a href="#cb7-116" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb7-117"><a href="#cb7-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-118"><a href="#cb7-118" aria-hidden="true" tabindex="-1"></a>            <span class="co"># # Execute the command</span></span>
<span id="cb7-119"><a href="#cb7-119" aria-hidden="true" tabindex="-1"></a>            <span class="co"># subprocess.run(ffmpeg_command, check=True)</span></span>
<span id="cb7-120"><a href="#cb7-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-121"><a href="#cb7-121" aria-hidden="true" tabindex="-1"></a>            <span class="co"># print(f'Video saved as {subfolder_path}')</span></span>
<span id="cb7-122"><a href="#cb7-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-123"><a href="#cb7-123" aria-hidden="true" tabindex="-1"></a>            <span class="co"># # --------------------------------------------------------------------------------------------</span></span>
<span id="cb7-124"><a href="#cb7-124" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb7-125"><a href="#cb7-125" aria-hidden="true" tabindex="-1"></a>            <span class="co">## 3a CLIP THE VIDEO USING MOVIEPY (SLOWER, BASED ON TIME)  </span></span>
<span id="cb7-126"><a href="#cb7-126" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Assign video extension to Four Character Code (fourcc) for the codec</span></span>
<span id="cb7-127"><a href="#cb7-127" aria-hidden="true" tabindex="-1"></a>            fourcc <span class="op">=</span> cv2.VideoWriter_fourcc(<span class="op">*</span>codec)</span>
<span id="cb7-128"><a href="#cb7-128" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb7-129"><a href="#cb7-129" aria-hidden="true" tabindex="-1"></a>            <span class="co"># output_video_folder ='./video_clipped_temp'  </span></span>
<span id="cb7-130"><a href="#cb7-130" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-131"><a href="#cb7-131" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb7-132"><a href="#cb7-132" aria-hidden="true" tabindex="-1"></a>            <span class="co"># find the codec based on the video extension </span></span>
<span id="cb7-133"><a href="#cb7-133" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> video_extension <span class="kw">in</span> extension_to_codec:</span>
<span id="cb7-134"><a href="#cb7-134" aria-hidden="true" tabindex="-1"></a>                codec <span class="op">=</span> extension_to_codec[video_extension]</span>
<span id="cb7-135"><a href="#cb7-135" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb7-136"><a href="#cb7-136" aria-hidden="true" tabindex="-1"></a>                <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"ERROR: The video extension </span><span class="sc">{</span>video_extension<span class="sc">}</span><span class="ss"> is not supported"</span>)</span>
<span id="cb7-137"><a href="#cb7-137" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb7-138"><a href="#cb7-138" aria-hidden="true" tabindex="-1"></a>            <span class="co"># assign code to Four Character Code (fourcc) for the codec </span></span>
<span id="cb7-139"><a href="#cb7-139" aria-hidden="true" tabindex="-1"></a>            fourcc <span class="op">=</span> cv2.VideoWriter_fourcc(<span class="op">*</span>codec)</span>
<span id="cb7-140"><a href="#cb7-140" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb7-141"><a href="#cb7-141" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Initialize the VideoWriter object to write frames to a new video file based on the fourcc codec, LSL frame rate, video frame size, and subfolder path</span></span>
<span id="cb7-142"><a href="#cb7-142" aria-hidden="true" tabindex="-1"></a>            out <span class="op">=</span> cv2.VideoWriter(subfolder_path, fourcc, LSL_frame_rate, (video_frame_width, video_frame_height))  </span>
<span id="cb7-143"><a href="#cb7-143" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb7-144"><a href="#cb7-144" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Write the selected frames to the a new clipped video </span></span>
<span id="cb7-145"><a href="#cb7-145" aria-hidden="true" tabindex="-1"></a>            capture.<span class="bu">set</span>(cv2.CAP_PROP_POS_FRAMES, start_frame)  <span class="co"># Set the video capture object to the start frame</span></span>
<span id="cb7-146"><a href="#cb7-146" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> tqdm(total<span class="op">=</span> end_frame <span class="op">-</span> start_frame <span class="op">+</span> <span class="dv">1</span>,   desc<span class="op">=</span><span class="st">"Rewriting Video Progress"</span>, leave<span class="op">=</span><span class="va">False</span>, ncols<span class="op">=</span><span class="dv">100</span>) <span class="im">as</span> pbar:    <span class="co"># Create a progress bar for the video frames</span></span>
<span id="cb7-147"><a href="#cb7-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-148"><a href="#cb7-148" aria-hidden="true" tabindex="-1"></a>                frame_count <span class="op">=</span> start_frame  <span class="co"># Initialize the frame count to the start frame</span></span>
<span id="cb7-149"><a href="#cb7-149" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb7-150"><a href="#cb7-150" aria-hidden="true" tabindex="-1"></a>                <span class="cf">while</span> capture.isOpened() <span class="kw">and</span> frame_count <span class="op">&lt;=</span> end_frame:  <span class="co"># Loop through the video frames from the start frame until the end frame is reached</span></span>
<span id="cb7-151"><a href="#cb7-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-152"><a href="#cb7-152" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">try</span>: </span>
<span id="cb7-153"><a href="#cb7-153" aria-hidden="true" tabindex="-1"></a>                        ret, frame <span class="op">=</span> capture.read()   <span class="co"># Read the next frame from the video</span></span>
<span id="cb7-154"><a href="#cb7-154" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> ret:   <span class="co"># If the frame is read correctly</span></span>
<span id="cb7-155"><a href="#cb7-155" aria-hidden="true" tabindex="-1"></a>                            frame_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb7-156"><a href="#cb7-156" aria-hidden="true" tabindex="-1"></a>                            pbar.update(<span class="dv">1</span>)</span>
<span id="cb7-157"><a href="#cb7-157" aria-hidden="true" tabindex="-1"></a>                            out.write(frame)  <span class="co"># Write the frame to the new video</span></span>
<span id="cb7-158"><a href="#cb7-158" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">else</span>:</span>
<span id="cb7-159"><a href="#cb7-159" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">break</span></span>
<span id="cb7-160"><a href="#cb7-160" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb7-161"><a href="#cb7-161" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:  <span class="co"># Catch any errors that occur during the frame processing</span></span>
<span id="cb7-162"><a href="#cb7-162" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">print</span>(<span class="ss">f"An error occurred at frame </span><span class="sc">{</span>frame_count<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb7-163"><a href="#cb7-163" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">break</span>  <span class="co"># Stop processing if an error occurs</span></span>
<span id="cb7-164"><a href="#cb7-164" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb7-165"><a href="#cb7-165" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb7-166"><a href="#cb7-166" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Release the video capture and video writer objects</span></span>
<span id="cb7-167"><a href="#cb7-167" aria-hidden="true" tabindex="-1"></a>            capture.release()</span>
<span id="cb7-168"><a href="#cb7-168" aria-hidden="true" tabindex="-1"></a>            out.release()</span>
<span id="cb7-169"><a href="#cb7-169" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-170"><a href="#cb7-170" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'Clipped video saved to: </span><span class="sc">{</span>subfolder_path<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb7-171"><a href="#cb7-171" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb7-172"><a href="#cb7-172" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb7-173"><a href="#cb7-173" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-174"><a href="#cb7-174" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>: <span class="co"># If no matching raw video is found</span></span>
<span id="cb7-175"><a href="#cb7-175" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'No matching raw video found for LSL video: </span><span class="sc">{</span>os<span class="sc">.</span>path<span class="sc">.</span>basename(<span class="bu">file</span>)<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb7-176"><a href="#cb7-176" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb7-177"><a href="#cb7-177" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb7-178"><a href="#cb7-178" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"All videos have been clipped successfully. Look into your folder "</span> <span class="op">+</span> output_video_folder) <span class="co">#as terminal            # Create the output subfolder for the clipped videos </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="merging-clipped-vidoes-with-clipped-audios" class="level2">
<h2 class="anchored" data-anchor-id="merging-clipped-vidoes-with-clipped-audios">3. Merging (Clipped) Vidoes with (Clipped) Audios</h2>
<div id="5dfb5a36" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">## FIRST RE-CREATE A LIST OF THE CLIPPED VIDEO FILES </span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>input_video_folder <span class="op">=</span> <span class="st">'./video_clipped/marker_3pairs'</span>     <span class="co"># this folder contains the clipped videos</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>condition_1 <span class="op">=</span> <span class="st">'Speech_Start_SUD_1_Start'</span>  <span class="co"># The condition to search for in the file name</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>condition_2 <span class="op">=</span> <span class="st">'SUD_1_End_SUD_2_Start'</span>  <span class="co"># The condition to search for in the file name</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>condition_3 <span class="op">=</span> <span class="st">'SUD_2_End_SUD_3_Start'</span>  <span class="co"># The condition to search for in the file name</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>clipped_video_list <span class="op">=</span> []  <span class="co"># Initialize an empty list to store paths of video files (csv LSL data)</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> os.path.exists(input_video_folder):  <span class="co"># Check if the input folder exists</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Traverse through the directory and its subdirectories to find video files</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> root, dirs, files <span class="kw">in</span> os.walk(os.path.abspath(input_video_folder)):  <span class="co"># Walk through the directory tree</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> files:</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> condition_1 <span class="kw">in</span> <span class="bu">file</span> <span class="kw">and</span> <span class="bu">file</span>.endswith(<span class="st">".avi"</span>):  <span class="co"># Check that the words "speech" and "output_compr" are in the file name and that it is a avi file</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>                    clipped_video_list.append(os.path.join(root, <span class="bu">file</span>))  <span class="co"># Append the full path to the xdf_files list</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> clipped_video_list :  <span class="co"># Check if any files were found</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f'We have identified the following Video files: </span><span class="sc">{</span>clipped_video_list<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:  <span class="co"># If no files were found</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">'No video files found.'</span>)</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>: <span class="co"># If the input folder does not exist or is not accessible</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'The folder </span><span class="sc">{</span>input_video_folder<span class="sc">}</span><span class="ss"> does not exist or is not accessible.'</span>)</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"An error occurred: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a><span class="co">## Also RE-CREATE A LIST OF THE AUDIO FILES TO match only 1 condition at at time </span></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a><span class="co">## 2. FIND AUDIO FILES (.wav files) IN THE INPUT FILE FOLDER</span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>audio_list <span class="op">=</span> []  <span class="co"># Initialize an empty list to store paths of video files (csv LSL data)</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> os.path.exists(input_video_folder):  <span class="co"># Check if the input folder exists</span></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Traverse through the directory and its subdirectories to find XDF files</span></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> root, dirs, files <span class="kw">in</span> os.walk(os.path.abspath(input_file_folder)):  <span class="co"># Walk through the directory tree</span></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> files:</span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> condition_1 <span class="kw">in</span> <span class="bu">file</span> <span class="kw">and</span> <span class="st">'Mic'</span> <span class="kw">in</span> <span class="bu">file</span> <span class="kw">and</span> <span class="st">'denoised'</span> <span class="kw">in</span> <span class="bu">file</span> <span class="kw">and</span> <span class="bu">file</span>.endswith(<span class="st">".wav"</span>):  <span class="co"># Check that the words "speech" and "Mic" and "denoised" are in the file name and that it is a wav file</span></span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>                    audio_list.append(os.path.join(root, <span class="bu">file</span>))  <span class="co"># Append the full path to the xdf_files list</span></span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> audio_list:  <span class="co"># Check if any files were found</span></span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f'We have identified the following Audio files: </span><span class="sc">{</span>audio_list<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:  <span class="co"># If no  files were found</span></span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">'No audio files found.'</span>)</span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>: <span class="co"># If the input folder does not exist or is not accessible</span></span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'The folder </span><span class="sc">{</span>input_file_folder<span class="sc">}</span><span class="ss"> does not exist or is not accessible.'</span>)</span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"An error occurred: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>We have identified the following Video files: ['f:\\SpeakUp-2.0\\2_PREPROCESSING\\2_Audio_Video_Sync\\video_clipped\\marker_3pairs\\pilot_01\\d2\\pilot_01_d2_Speech_Start_SUD_1_Start.avi', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\2_Audio_Video_Sync\\video_clipped\\marker_3pairs\\pilot_01\\d3\\pilot_01_d3_Speech_Start_SUD_1_Start.avi', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\2_Audio_Video_Sync\\video_clipped\\marker_3pairs\\pilot_02\\d2\\pilot_02_d2_Speech_Start_SUD_1_Start.avi', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\2_Audio_Video_Sync\\video_clipped\\marker_3pairs\\pilot_02\\d3\\pilot_02_d3_Speech_Start_SUD_1_Start.avi', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\2_Audio_Video_Sync\\video_clipped\\marker_3pairs\\pilot_04\\d2\\pilot_04_d2_Speech_Start_SUD_1_Start.avi', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\2_Audio_Video_Sync\\video_clipped\\marker_3pairs\\pilot_05\\d2\\pilot_05_d2_Speech_Start_SUD_1_Start.avi', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\2_Audio_Video_Sync\\video_clipped\\marker_3pairs\\pilot_06\\d2\\pilot_06_d2_Speech_Start_SUD_1_Start.avi']
We have identified the following Audio files: ['f:\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed_final\\marker_3pairs\\pilot_01\\day2\\pilot_01_d2_speech_lsl_Mic_Speech_Start_SUD_1_Start_denoised.wav', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed_final\\marker_3pairs\\pilot_01\\day3\\pilot_01_d3_speech_lsl_Mic_Speech_Start_SUD_1_Start_denoised.wav', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed_final\\marker_3pairs\\pilot_02\\day2\\pilot_02_d2_speech_lsl_Mic_Speech_Start_SUD_1_Start_denoised.wav', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed_final\\marker_3pairs\\pilot_02\\day3\\pilot_02_d3_speech_lsl_Mic_Speech_Start_SUD_1_Start_denoised.wav', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed_final\\marker_3pairs\\pilot_04\\day2\\pilot_04_d2_speech_lsl_Mic_Speech_Start_SUD_1_Start_denoised.wav', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed_final\\marker_3pairs\\pilot_05\\day2\\pilot_05_d2_speech_lsl_Mic_Speech_Start_SUD_1_Start_denoised.wav', 'f:\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed_final\\marker_3pairs\\pilot_06\\day2\\pilot_06_d2_speech_lsl_Mic_Speech_Start_SUD_1_Start_denoised.wav']</code></pre>
</div>
</div>
<div id="34653809" class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># THEN WE USE THESE CLIPPED VIDEOS AND ALIGNM THEM TO THE CORREPSONDING AUDIO </span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co"># LOADING AUDIOS: Loop over files in the input_file_folder to extract the relevant audio files</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> audio <span class="kw">in</span> audio_list:    </span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'Processing the audio file:  </span><span class="sc">{</span>audio<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    audio_path <span class="op">=</span> os.path.join(os.path.abspath(input_file_folder), audio)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    fnam <span class="op">=</span> os.path.basename(audio)[:<span class="op">-</span><span class="dv">4</span>]  </span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    participant_num <span class="op">=</span> <span class="st">'_'</span>.join(fnam.split(<span class="st">'_'</span>)[<span class="dv">0</span>:<span class="dv">2</span>])  <span class="co"># Extract the participant number from the file name by splitting the string at the underscores and selecting the first two elements</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'Participant number: </span><span class="sc">{</span>participant_num<span class="sc">}</span><span class="ss">'</span>)  <span class="co"># Print the participant number</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    day_num <span class="op">=</span> fnam.split(<span class="st">'_'</span>)[<span class="dv">2</span>]  <span class="co"># Extract the day number from the file name by splitting the string at the underscores and selecting the third element</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'Day number: </span><span class="sc">{</span>day_num<span class="sc">}</span><span class="ss">'</span>)  <span class="co"># Print the day number</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>    condition <span class="op">=</span> <span class="st">'_'</span>.join(fnam.split(<span class="st">'_'</span>)[<span class="dv">6</span>:])  <span class="co"># Extract the condition from the file name by splitting the string at the underscores and selecting the elements from the 7th to the last element</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract the identifier from the audio file name that will be used to match the video file</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    audio_match <span class="op">=</span> audio_video_pattern_matching.search(fnam)</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> audio_match:</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'No matching for audio: </span><span class="sc">{</span>audio<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span>  <span class="co"># Skip current iteration if the pattern is not found</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>    audio_identifier <span class="op">=</span> audio_match.group(<span class="dv">0</span>)  <span class="co"># Extract the matched portion of the string from the regex result.</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">#print(f'Audio identifier: {audio_identifier}')  # Print the matched identifier for audio</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># LOADING VIDEOS: Loop over video files to select the corresponding video file</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> video <span class="kw">in</span> clipped_video_list:</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>        fnam <span class="op">=</span> os.path.basename(video)[:<span class="op">-</span><span class="dv">4</span>]  </span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract the identifier from the video file name that will be used to match the audio file</span></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>        video_match <span class="op">=</span> audio_video_pattern_matching.search(fnam)</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> video_match:</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f'No matching for video: </span><span class="sc">{</span>video<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span>  <span class="co"># Skip current iteration if the pattern is not found</span></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>        video_identifier <span class="op">=</span> video_match.group(<span class="dv">0</span>)  <span class="co"># Extract the matched portion of the string from the regex result.</span></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>        <span class="co">#print(f'Video identifier: {video_identifier}')  # Print the matched identifier for video</span></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check if the identifiers from the audio and video files match</span></span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> audio_identifier <span class="op">==</span> video_identifier: </span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>            video_path <span class="op">=</span> os.path.join(os.path.abspath(input_video_folder), video)</span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>            video_extension <span class="op">=</span> os.path.splitext(video_path)[<span class="dv">1</span>].lower()  <span class="co"># Ensure correct video extension</span></span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f'Found matching video: </span><span class="sc">{</span>video<span class="sc">}</span><span class="ss"> for audio: </span><span class="sc">{</span>audio<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Create output folder if it doesn't exist</span></span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>            os.makedirs(output_audiovideo_folder, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>            <span class="co"># ALIGNMENT: Combining Audio and Video using ffmpeg </span></span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>            subfolder_path <span class="op">=</span> os.path.join(os.path.abspath(output_audiovideo_folder), participant_num, day_num, <span class="ss">f'</span><span class="sc">{</span>video_identifier<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>condition<span class="sc">}</span><span class="ss">_audiovideo_merged.</span><span class="sc">{</span>video_extension[<span class="dv">1</span>:]<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a>            <span class="co">#make sure the output folder exists, if not create it</span></span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> os.path.exists(os.path.dirname(subfolder_path)):</span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a>                os.makedirs(os.path.dirname(subfolder_path), exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Construct the ffmpeg command to combine the audio and video files</span></span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a>            ffmpeg_command <span class="op">=</span> [</span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a>                <span class="st">'ffmpeg'</span>,              <span class="co"># Call the ffmpeg tool</span></span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a>                <span class="st">'-y'</span>,                  <span class="co"># Overwrite the output file without asking</span></span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a>                <span class="st">'-i'</span>, video_path,      <span class="co"># Specify the input video file</span></span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a>                <span class="st">'-i'</span>, audio_path,      <span class="co"># Specify the input audio file</span></span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true" tabindex="-1"></a>                <span class="st">'-c:v'</span>, <span class="st">'copy'</span>,        <span class="co"># Copy the video stream without re-encoding</span></span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true" tabindex="-1"></a>                <span class="st">'-c:a'</span>, <span class="st">'aac'</span>,         <span class="co"># Re-encode the audio stream to AAC format (optimized for playback devices)</span></span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true" tabindex="-1"></a>                <span class="st">'-strict'</span>, <span class="st">'experimental'</span>,  <span class="co"># Enable experimental features (needed for AAC encoding in some versions)</span></span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true" tabindex="-1"></a>                subfolder_path         <span class="co"># Specify the output file path (video with audio)</span></span>
<span id="cb10-75"><a href="#cb10-75" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb10-76"><a href="#cb10-76" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb10-77"><a href="#cb10-77" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Run the command </span></span>
<span id="cb10-78"><a href="#cb10-78" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">'Now combining this Audio and Video'</span>)</span>
<span id="cb10-79"><a href="#cb10-79" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb10-80"><a href="#cb10-80" aria-hidden="true" tabindex="-1"></a>                result <span class="op">=</span> subprocess.run(ffmpeg_command, check<span class="op">=</span><span class="va">True</span>, capture_output<span class="op">=</span><span class="va">True</span>, text<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-81"><a href="#cb10-81" aria-hidden="true" tabindex="-1"></a>                <span class="co">#print(result.stdout)</span></span>
<span id="cb10-82"><a href="#cb10-82" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb10-83"><a href="#cb10-83" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f'Video with audio saved as </span><span class="sc">{</span>subfolder_path<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb10-84"><a href="#cb10-84" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb10-85"><a href="#cb10-85" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> subprocess.CalledProcessError <span class="im">as</span> e:</span>
<span id="cb10-86"><a href="#cb10-86" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"Error combining audio and video </span><span class="sc">{</span>video_path<span class="sc">}</span><span class="ss"> and </span><span class="sc">{</span>audio_path<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">.</span>stderr<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-87"><a href="#cb10-87" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb10-88"><a href="#cb10-88" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb10-89"><a href="#cb10-89" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb10-90"><a href="#cb10-90" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Done, you can now look into the folder: </span><span class="sc">{</span>output_audiovideo_folder<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="optional-overlay-lsl-time-on-the-audiovideos" class="level2">
<h2 class="anchored" data-anchor-id="optional-overlay-lsl-time-on-the-audiovideos">4. (Optional) Overlay LSL Time on the AudioVideos</h2>
<section id="this-step-is-useful-to-double-check-whether-the-marker-event-informaiton-was-coded-correctly-during-the-recording." class="level5">
<h5 class="anchored" data-anchor-id="this-step-is-useful-to-double-check-whether-the-marker-event-informaiton-was-coded-correctly-during-the-recording.">This step is useful to double check whether the Marker &amp; Event informaiton was coded correctly during the recording.</h5>
<div id="f8a31454" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">## 1.  AGAIN, FIND ALL THE AUDIO-VIDEO SYNCED FILES IN THE INPUT FOLDER </span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>input_audiovideo_folder <span class="op">=</span> <span class="st">'./audiovideo_sync/lateststart_earliestend'</span>     <span class="co"># this folder contains the audio-video synced files</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>audiovideo_list <span class="op">=</span> []  <span class="co"># Initialize an empty list to store paths of video files (csv LSL data)</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> os.path.exists(input_audiovideo_folder):  <span class="co"># Check if the input folder exists</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Traverse through the directory and its subdirectories to find XDF files</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> root, dirs, files <span class="kw">in</span> os.walk(os.path.abspath(input_audiovideo_folder)):  <span class="co"># Walk through the directory tree</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> files:</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="st">"synced"</span> <span class="kw">in</span> <span class="bu">file</span> <span class="kw">and</span> <span class="bu">file</span>.endswith(<span class="st">".avi"</span>):  <span class="co"># Check that the words "speech" and "output_compr" are in the file name and that it is a avi file</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>                    audiovideo_list.append(os.path.join(root, <span class="bu">file</span>))  <span class="co"># Append the full path to the xdf_files list</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> audiovideo_list :  <span class="co"># Check if any files were found</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f'We have identified the following audiovideo files: </span><span class="sc">{</span>audiovideo_list<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:  <span class="co"># If no files were found</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">'No video files found.'</span>)</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>: <span class="co"># If the input folder does not exist or is not accessible</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'The folder </span><span class="sc">{</span>input_audiovideo_folder<span class="sc">}</span><span class="ss"> does not exist or is not accessible.'</span>)</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"An error occurred: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a><span class="co">## 2. FIND THE CORRESPONDING LSL VIDEO FILES IN THE INPUT FOLDER</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a><span class="co"># We use the LSL_video_list that was created before</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'We will use the following LSL Video Files to overlay LSL Times: </span><span class="sc">{</span>LSL_video_list<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>We have identified the following audiovideo files: ['c:\\Users\\ahmar\\OneDrive\\Documents\\GitHub\\SpeakUp-2.0\\2_PREPROCESSING\\2_Audio_Video_Sync\\audiovideo_sync\\lateststart_earliestend\\pilot_01\\d2\\pilot_01_d2_speech_audiovideo_synced.avi', 'c:\\Users\\ahmar\\OneDrive\\Documents\\GitHub\\SpeakUp-2.0\\2_PREPROCESSING\\2_Audio_Video_Sync\\audiovideo_sync\\lateststart_earliestend\\pilot_01\\d3\\pilot_01_d3_speech_audiovideo_synced.avi', 'c:\\Users\\ahmar\\OneDrive\\Documents\\GitHub\\SpeakUp-2.0\\2_PREPROCESSING\\2_Audio_Video_Sync\\audiovideo_sync\\lateststart_earliestend\\pilot_02\\d2\\pilot_02_d2_speech_audiovideo_synced.avi', 'c:\\Users\\ahmar\\OneDrive\\Documents\\GitHub\\SpeakUp-2.0\\2_PREPROCESSING\\2_Audio_Video_Sync\\audiovideo_sync\\lateststart_earliestend\\pilot_02\\d3\\pilot_02_d3_speech_audiovideo_synced.avi', 'c:\\Users\\ahmar\\OneDrive\\Documents\\GitHub\\SpeakUp-2.0\\2_PREPROCESSING\\2_Audio_Video_Sync\\audiovideo_sync\\lateststart_earliestend\\pilot_03\\d2\\pilot_03_d2_speech_audiovideo_synced.avi', 'c:\\Users\\ahmar\\OneDrive\\Documents\\GitHub\\SpeakUp-2.0\\2_PREPROCESSING\\2_Audio_Video_Sync\\audiovideo_sync\\lateststart_earliestend\\pilot_04\\d2\\pilot_04_d2_speech_audiovideo_synced.avi', 'c:\\Users\\ahmar\\OneDrive\\Documents\\GitHub\\SpeakUp-2.0\\2_PREPROCESSING\\2_Audio_Video_Sync\\audiovideo_sync\\lateststart_earliestend\\pilot_05\\d2\\pilot_05_d2_speech_audiovideo_synced.avi', 'c:\\Users\\ahmar\\OneDrive\\Documents\\GitHub\\SpeakUp-2.0\\2_PREPROCESSING\\2_Audio_Video_Sync\\audiovideo_sync\\lateststart_earliestend\\pilot_06\\d2\\pilot_06_d2_speech_audiovideo_synced.avi']
We will use the following LSL Video Files to overlay LSL Times: ['c:\\Users\\ahmar\\OneDrive\\Documents\\GitHub\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed\\lateststart_earliestend\\pilot_01\\day2\\pilot_01_d2_speech_lsl_Video_latest_start_earliest_end.csv', 'c:\\Users\\ahmar\\OneDrive\\Documents\\GitHub\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed\\lateststart_earliestend\\pilot_01\\day3\\pilot_01_d3_speech_lsl_Video_latest_start_earliest_end.csv', 'c:\\Users\\ahmar\\OneDrive\\Documents\\GitHub\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed\\lateststart_earliestend\\pilot_02\\day2\\pilot_02_d2_speech_lsl_Video_latest_start_earliest_end.csv', 'c:\\Users\\ahmar\\OneDrive\\Documents\\GitHub\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed\\lateststart_earliestend\\pilot_02\\day3\\pilot_02_d3_speech_lsl_Video_latest_start_earliest_end.csv', 'c:\\Users\\ahmar\\OneDrive\\Documents\\GitHub\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed\\lateststart_earliestend\\pilot_03\\day2\\pilot_03_d2_speech_lsl_Video_latest_start_earliest_end.csv', 'c:\\Users\\ahmar\\OneDrive\\Documents\\GitHub\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed\\lateststart_earliestend\\pilot_04\\day2\\pilot_04_d2_speech_lsl_Video_latest_start_earliest_end.csv', 'c:\\Users\\ahmar\\OneDrive\\Documents\\GitHub\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed\\lateststart_earliestend\\pilot_05\\day2\\pilot_05_d2_speech_lsl_Video_latest_start_earliest_end.csv', 'c:\\Users\\ahmar\\OneDrive\\Documents\\GitHub\\SpeakUp-2.0\\2_PREPROCESSING\\1_XDF_PROCESSING\\data_processed\\lateststart_earliestend\\pilot_06\\day2\\pilot_06_d2_speech_lsl_Video_latest_start_earliest_end.csv']</code></pre>
</div>
</div>
<div id="287e6c96" class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">## 3 NOW WE OVERLAY LSL TIMES ON THE AUDIO-VIDEO SYNCED FILES</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Loading the relevant CSV files for each participant</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> LSL_video_list: </span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    fnam <span class="op">=</span> os.path.basename(<span class="bu">file</span>)[:<span class="op">-</span><span class="dv">4</span>]  <span class="co"># Extract the file name from the path and remove the '.csv' extension (i.e., the last 4 characters in the string)</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'Processing the LSL video file </span><span class="sc">{</span><span class="bu">file</span><span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    file_path <span class="op">=</span> os.path.join(os.path.abspath(input_file_folder), <span class="bu">file</span>)</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    participant_num <span class="op">=</span> <span class="st">'_'</span>.join(fnam.split(<span class="st">'_'</span>)[<span class="dv">0</span>:<span class="dv">2</span>])  <span class="co"># Extract the participant number from the file name by splitting the string at the underscores and selecting the first two elements</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    day_num <span class="op">=</span> fnam.split(<span class="st">'_'</span>)[<span class="dv">2</span>]  <span class="co"># Extract the day number from the file name by splitting the string at the underscores and selecting the third element</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Reading the CSV file </span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    file_data <span class="op">=</span> pd.read_csv(<span class="bu">file</span>) <span class="co"># Reads the CSV file at the constructed path into a DataFrame called file_data </span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract LSL time and frame number from CSV</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    lsl_times <span class="op">=</span> file_data.iloc[:, <span class="dv">0</span>]  </span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    lsl_frames <span class="op">=</span> file_data.iloc[:, <span class="dv">1</span>]  </span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract LSL video identifier </span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    LSL_video_match <span class="op">=</span> audio_video_pattern_matching.search(fnam)</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> LSL_video_match: </span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span> </span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>    LSL_video_identifier <span class="op">=</span> LSL_video_match.group(<span class="dv">0</span>) </span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Loading the corresponding audiovideo files </span></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> audiovideo <span class="kw">in</span> audiovideo_list: </span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>        fnam <span class="op">=</span> os.path.basename(audiovideo)[:<span class="op">-</span><span class="dv">4</span>]  <span class="co"># Extract the file name from the path and remove the '.avi' extension (i.e., the last 4 characters in the string)</span></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract the audiovideo identifier based on the pattern: </span></span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>        audiovideo_match <span class="op">=</span> audio_video_pattern_matching.search(fnam)</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>       <span class="co">#print(f'Video identifier: {video_identifier}')  # Print the matched identifier for video</span></span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check tha that the LSL and the audio video identifier match </span></span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> audiovideo_identifier <span class="op">==</span> LSL_video_identifier: </span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a>            audiovideo_path <span class="op">=</span> os.path.join(os.path.abspath(input_audiovideo_folder), audiovideo)</span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"Found matching audiovideo file: "</span> <span class="op">+</span> os.path.basename(audiovideo) <span class="op">+</span> <span class="st">"for LSL video "</span> <span class="op">+</span> os.path.basename(<span class="bu">file</span>)) </span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Now Loading the video and extracting relevant metadata </span></span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">'Now loading video: '</span> <span class="op">+</span> audiovideo)</span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a>            capture <span class="op">=</span> cv2.VideoCapture(audiovideo_path)  <span class="co"># Load the video using OpenCV</span></span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a>            video_frame_width  <span class="op">=</span> <span class="bu">int</span>(capture.get(cv2.CAP_PROP_FRAME_WIDTH))  </span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a>            video_frame_height <span class="op">=</span> <span class="bu">int</span>(capture.get(cv2.CAP_PROP_FRAME_HEIGHT))  </span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a>            video_frame_rate   <span class="op">=</span> capture.get(cv2.CAP_PROP_FPS)</span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a>            video_tot_frames   <span class="op">=</span> <span class="bu">int</span>(capture.get(cv2.CAP_PROP_FRAME_COUNT))</span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a>               </span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-62"><a href="#cb13-62" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Find the codec based on the video extension</span></span>
<span id="cb13-63"><a href="#cb13-63" aria-hidden="true" tabindex="-1"></a>            video_extension <span class="op">=</span> os.path.splitext(audiovideo_path)[<span class="dv">1</span>].lower()  <span class="co"># Extract the file extension from the video file path, ensuring it's in lowercase (e.g., '.mp4'), to enable case-insensitive matching in the dictionary</span></span>
<span id="cb13-64"><a href="#cb13-64" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> video_extension <span class="kw">in</span> extension_to_codec: </span>
<span id="cb13-65"><a href="#cb13-65" aria-hidden="true" tabindex="-1"></a>                codec <span class="op">=</span> extension_to_codec[video_extension]</span>
<span id="cb13-66"><a href="#cb13-66" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb13-67"><a href="#cb13-67" aria-hidden="true" tabindex="-1"></a>                <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"ERROR: The video extension </span><span class="sc">{</span>video_extension<span class="sc">}</span><span class="ss"> is not supported"</span>)</span>
<span id="cb13-68"><a href="#cb13-68" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-69"><a href="#cb13-69" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Create the Output Folder for the overlayed videos</span></span>
<span id="cb13-70"><a href="#cb13-70" aria-hidden="true" tabindex="-1"></a>            subfolder_path <span class="op">=</span> os.path.join(os.path.abspath(output_overlay_folder), participant_num, day_num, <span class="ss">f'</span><span class="sc">{</span>participant_num<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>day_num<span class="sc">}</span><span class="ss">_Speech_Video_overlayed</span><span class="sc">{</span>video_extension<span class="sc">}</span><span class="ss">'</span>)  <span class="co"># Create the output subfolder for the clipped video with the correct extension</span></span>
<span id="cb13-71"><a href="#cb13-71" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Make sure the output folder exists, if not create it</span></span>
<span id="cb13-72"><a href="#cb13-72" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> os.path.exists(os.path.dirname(subfolder_path)):</span>
<span id="cb13-73"><a href="#cb13-73" aria-hidden="true" tabindex="-1"></a>                os.makedirs(os.path.dirname(subfolder_path), exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb13-74"><a href="#cb13-74" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-75"><a href="#cb13-75" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Create the output video writer</span></span>
<span id="cb13-76"><a href="#cb13-76" aria-hidden="true" tabindex="-1"></a>            fourcc <span class="op">=</span> cv2.VideoWriter_fourcc(<span class="op">*</span>codec)  </span>
<span id="cb13-77"><a href="#cb13-77" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-78"><a href="#cb13-78" aria-hidden="true" tabindex="-1"></a>            video_writer <span class="op">=</span> cv2.VideoWriter(subfolder_path, fourcc, video_frame_rate, (video_frame_width, video_frame_height))</span>
<span id="cb13-79"><a href="#cb13-79" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-80"><a href="#cb13-80" aria-hidden="true" tabindex="-1"></a>            capture <span class="op">=</span> cv2.VideoCapture(audiovideo_path)  </span>
<span id="cb13-81"><a href="#cb13-81" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-82"><a href="#cb13-82" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">'Now overlaying LSL time onto video frames for video '</span> <span class="op">+</span> <span class="bu">str</span>(os.path.basename(audiovideo)) <span class="op">+</span> <span class="st">" with csv file  "</span> <span class="op">+</span> <span class="bu">str</span>(os.path.basename(<span class="bu">file</span>)))</span>
<span id="cb13-83"><a href="#cb13-83" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-84"><a href="#cb13-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-85"><a href="#cb13-85" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Process the video frame by frame</span></span>
<span id="cb13-86"><a href="#cb13-86" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> i <span class="kw">in</span> tqdm(<span class="bu">range</span>(video_tot_frames), desc<span class="op">=</span><span class="st">"Processing Video"</span>, unit<span class="op">=</span><span class="st">"frame"</span>):</span>
<span id="cb13-87"><a href="#cb13-87" aria-hidden="true" tabindex="-1"></a>                ret, frame <span class="op">=</span> capture.read()  <span class="co"># Read a frame</span></span>
<span id="cb13-88"><a href="#cb13-88" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">not</span> ret:</span>
<span id="cb13-89"><a href="#cb13-89" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span>  <span class="co"># Exit loop if no more frames are available</span></span>
<span id="cb13-90"><a href="#cb13-90" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb13-91"><a href="#cb13-91" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Get the actual frame number from the video capture object</span></span>
<span id="cb13-92"><a href="#cb13-92" aria-hidden="true" tabindex="-1"></a>                current_frame_number <span class="op">=</span> capture.get(cv2.CAP_PROP_POS_FRAMES)</span>
<span id="cb13-93"><a href="#cb13-93" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="st">"Current frame number: "</span> <span class="op">+</span> <span class="bu">str</span>(current_frame_number))</span>
<span id="cb13-94"><a href="#cb13-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-95"><a href="#cb13-95" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Check if the frame counter is within the range of LSL frames</span></span>
<span id="cb13-96"><a href="#cb13-96" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> lsl_frames.iloc[<span class="dv">0</span>] <span class="op">&lt;=</span> frame_counter <span class="op">&lt;=</span> lsl_frames.iloc[<span class="op">-</span><span class="dv">1</span>]:</span>
<span id="cb13-97"><a href="#cb13-97" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Find the corresponding LSL time and frame number based on the frame counter</span></span>
<span id="cb13-98"><a href="#cb13-98" aria-hidden="true" tabindex="-1"></a>                    match <span class="op">=</span> file_data[file_data.iloc[:, <span class="dv">1</span>] <span class="op">==</span> <span class="bu">int</span>(current_frame_number)]</span>
<span id="cb13-99"><a href="#cb13-99" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="kw">not</span> match.empty:</span>
<span id="cb13-100"><a href="#cb13-100" aria-hidden="true" tabindex="-1"></a>                        lsl_time <span class="op">=</span> match.iloc[<span class="dv">0</span>, <span class="dv">0</span>]  <span class="co"># LSL time</span></span>
<span id="cb13-101"><a href="#cb13-101" aria-hidden="true" tabindex="-1"></a>                        lsl_frame <span class="op">=</span> match.iloc[<span class="dv">0</span>, <span class="dv">1</span>]  <span class="co"># Frame number</span></span>
<span id="cb13-102"><a href="#cb13-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-103"><a href="#cb13-103" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Overlay the LSL information onto the video frame</span></span>
<span id="cb13-104"><a href="#cb13-104" aria-hidden="true" tabindex="-1"></a>                        overlay_text <span class="op">=</span> <span class="ss">f'LSL Time: </span><span class="sc">{</span>lsl_time<span class="sc">:.3f}</span><span class="ss">, Frame: </span><span class="sc">{</span><span class="bu">int</span>(lsl_frame)<span class="sc">}</span><span class="ss">'</span></span>
<span id="cb13-105"><a href="#cb13-105" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Calculate the center position for the text</span></span>
<span id="cb13-106"><a href="#cb13-106" aria-hidden="true" tabindex="-1"></a>                        text_size <span class="op">=</span> cv2.getTextSize(overlay_text, cv2.FONT_HERSHEY_SIMPLEX, <span class="dv">1</span>, <span class="dv">2</span>)[<span class="dv">0</span>]</span>
<span id="cb13-107"><a href="#cb13-107" aria-hidden="true" tabindex="-1"></a>                        text_x <span class="op">=</span> (video_frame_width <span class="op">-</span> text_size[<span class="dv">0</span>]) <span class="op">//</span> <span class="dv">2</span>  <span class="co"># X-coordinate</span></span>
<span id="cb13-108"><a href="#cb13-108" aria-hidden="true" tabindex="-1"></a>                        text_y <span class="op">=</span> (video_frame_height <span class="op">+</span> text_size[<span class="dv">1</span>]) <span class="op">//</span> <span class="dv">2</span>  <span class="co"># Y-coordinate</span></span>
<span id="cb13-109"><a href="#cb13-109" aria-hidden="true" tabindex="-1"></a>                        cv2.putText(frame, overlay_text, </span>
<span id="cb13-110"><a href="#cb13-110" aria-hidden="true" tabindex="-1"></a>                                    (text_x, text_y),  <span class="co"># Position in the center</span></span>
<span id="cb13-111"><a href="#cb13-111" aria-hidden="true" tabindex="-1"></a>                                    cv2.FONT_HERSHEY_SIMPLEX, <span class="dv">1</span>, </span>
<span id="cb13-112"><a href="#cb13-112" aria-hidden="true" tabindex="-1"></a>                                    (<span class="dv">255</span>, <span class="dv">255</span>, <span class="dv">255</span>), <span class="dv">2</span>)  <span class="co"># White text with thickness of 2</span></span>
<span id="cb13-113"><a href="#cb13-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-114"><a href="#cb13-114" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Write the frame to the output video, regardless of overlay</span></span>
<span id="cb13-115"><a href="#cb13-115" aria-hidden="true" tabindex="-1"></a>                video_writer.write(frame)</span>
<span id="cb13-116"><a href="#cb13-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-117"><a href="#cb13-117" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Release resources after processing all frames</span></span>
<span id="cb13-118"><a href="#cb13-118" aria-hidden="true" tabindex="-1"></a>            capture.release()</span>
<span id="cb13-119"><a href="#cb13-119" aria-hidden="true" tabindex="-1"></a>            video_writer.release()</span>
<span id="cb13-120"><a href="#cb13-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-121"><a href="#cb13-121" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f'Video saved as </span><span class="sc">{</span>subfolder_path<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb13-122"><a href="#cb13-122" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-123"><a href="#cb13-123" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb13-124"><a href="#cb13-124" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb13-125"><a href="#cb13-125" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-126"><a href="#cb13-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-127"><a href="#cb13-127" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Done with processing all videos! You can now look into your folder: "</span> <span class="op">+</span> output_overlay_folder)</span>
<span id="cb13-128"><a href="#cb13-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-129"><a href="#cb13-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-130"><a href="#cb13-130" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb13-131"><a href="#cb13-131" aria-hidden="true" tabindex="-1"></a>                </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>